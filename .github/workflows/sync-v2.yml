name: sync-v2

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ¸…ç©º v2.txt
      - name: Clear v2.txt
        run: echo -n > v2.txt

      # åˆå¹¶ wd.md å†…å®¹
      - name: Merge wd.md
        run: |
          cat wd.md >> v2.txt
          echo -e "\n" >> v2.txt

      # åˆå¹¶ dz1.txt ä¸­çš„è®¢é˜…é“¾æŽ¥
      - name: Merge dz1.txt links
        run: |
          while IFS= read -r url; do
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            raw_url="$url"
            if [[ "$url" == https://github.com/* ]]; then
              raw_url=$(echo "$url" | sed -E 's#https://github.com/([^/]+)/([^/]+)/blob/(.+)#https://raw.githubusercontent.com/\1/\2/\3#')
            fi
            echo "Fetching: $raw_url"
            content=$(curl -fsSL "$raw_url")
            if echo "$content" | grep -qE '^[A-Za-z0-9+/=]+$'; then
              echo "$content" | base64 -d >> v2.txt || echo "# âš ï¸ è§£ç å¤±è´¥: $raw_url" >> v2.txt
            else
              echo "$content" >> v2.txt
            fi
            echo -e "\n" >> v2.txt
          done < dz1.txt

      # åˆå¹¶ dz2.txt ä¸­çš„ GitHub ä»“åº“ï¼ˆåªå–æœ€æ–°æäº¤ä¸­çš„ .txt æ–‡ä»¶ï¼‰
      - name: Merge dz2.txt GitHub repos
        run: |
          while IFS= read -r repo_url; do
            [[ -z "$repo_url" || "$repo_url" =~ ^# ]] && continue
            echo "ðŸ” æ‰«æä»“åº“: $repo_url"
            if [[ "$repo_url" =~ github.com/([^/]+)/([^/]+) ]]; then
              user="${BASH_REMATCH[1]}"
              repo="${BASH_REMATCH[2]}"
              branch=$(curl -s https://api.github.com/repos/$user/$repo | jq -r .default_branch)
              commit_sha=$(curl -s https://api.github.com/repos/$user/$repo/commits/$branch | jq -r .sha)
              files=$(curl -s https://api.github.com/repos/$user/$repo/commits/$commit_sha | jq -r '.files[] | select(.filename | endswith(".txt")) | .filename')
              for file in $files; do
                raw_url="https://raw.githubusercontent.com/$user/$repo/$branch/$file"
                echo "ðŸ“„ èŽ·å–æ–‡ä»¶: $raw_url"
                content=$(curl -fsSL "$raw_url")
                if echo "$content" | grep -qE '^[A-Za-z0-9+/=]+$'; then
                  echo "$content" | base64 -d >> v2.txt || echo "# âš ï¸ è§£ç å¤±è´¥: $raw_url" >> v2.txt
                else
                  echo "$content" >> v2.txt
                fi
                echo -e "\n" >> v2.txt
                break
              done
            fi
          done < dz2.txt

      # å®‰è£… Python ä¾èµ–å¹¶æ‰§è¡ŒåŸŽå¸‚è¯†åˆ« + é‡å‘½å
      - name: Rename nodes with city info
        run: |
          pip install requests
          python3 merge_nodes.py

      # å®‰è£… Xray-coreï¼ˆç¡®ä¿æ”¯æŒ test å‘½ä»¤ï¼‰
      - name: Install Xray-core
        run: |
          XRAY_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          echo "âœ… æœ€æ–°ç‰ˆæœ¬: $XRAY_VERSION"
          curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/${XRAY_VERSION}/Xray-linux-64.zip
          unzip -o xray.zip
          chmod +x xray
          sudo mv xray /usr/local/bin/
          xray version
          xray help | grep test || echo "âŒ å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒ test å‘½ä»¤"

      # æ‰§è¡Œæµ‹é€Ÿè„šæœ¬
      - name: Run speed test
        run: python3 speed_test.py

      # è®¾ç½® Git èº«ä»½
      - name: Set Git identity
        run: |
          git config --global user.name "${{ github.repository_owner }}"
          git config --global user.email "${{ github.repository_owner }}@users.noreply.github.com"

      # æäº¤å¹¶æŽ¨é€æ›´æ–°
      - name: Commit and push results
        run: |
          git add v2.txt
          git commit -m "Auto-sync v2.txt with city and speed test"
          git push
