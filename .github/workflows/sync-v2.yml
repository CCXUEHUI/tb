name: Sync V2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点执行

jobs:
  sync-v2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pyyaml ipaddress

      - name: Step 1 - Merge proxies to v2.txt
        run: python py/step1_merge_proxies.py

      - name: Step 2 - Convert v2.txt to Clash config.yaml
        run: python py/step2_convert_to_clash.py

#      - name: Step 3 - Test nodes and update config.yaml
#        run: sudo apt install -y curl && python py/step3_test_nodes.py

#      - name: Step 4 - Convert config.yaml to v2ray format
#        run: python py/step4_convert_to_v2ray.py

#      - name: Step 5 - Add city names to v2.txt
#        run: python py/step5_add_city_names.py

      - name: Commit changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add v2.txt config.yaml
          git commit -m "Update v2.txt and config.yaml"
          git push
